<!DOCTYPE html>
<html lang="en-us" dir="ltr">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="\nThe Old Way Direnv What is direnv and how it works direnv installation Shell configuration How Python works with direnv Pyenv Installation and Configuration Use pyenv with direnv Poetry What is Poetry Poetry installation Shell configuration New project Existing project Poetry usage Link Poetry with direnv GPG Generate a key Get key ID Pass Pass installation Pass usage Tomb Tomb installation Tomb usage Secrets with Direnv and Pass Direnv advanced configurations Check for commands dependencies Third-party binaries Third-party configs Final template Conclusion Disclaimer: I&rsquo;m not saying virtualenv methods are bad.\n">
<title>Ultimate Python development environment configuration</title>

<link rel='canonical' href='http://localhost:1313/posts/ultimate-python-development-environment-configuration/'>

<link rel="stylesheet" href="/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css"><meta property='og:title' content="Ultimate Python development environment configuration">
<meta property='og:description' content="\nThe Old Way Direnv What is direnv and how it works direnv installation Shell configuration How Python works with direnv Pyenv Installation and Configuration Use pyenv with direnv Poetry What is Poetry Poetry installation Shell configuration New project Existing project Poetry usage Link Poetry with direnv GPG Generate a key Get key ID Pass Pass installation Pass usage Tomb Tomb installation Tomb usage Secrets with Direnv and Pass Direnv advanced configurations Check for commands dependencies Third-party binaries Third-party configs Final template Conclusion Disclaimer: I&rsquo;m not saying virtualenv methods are bad.\n">
<meta property='og:url' content='http://localhost:1313/posts/ultimate-python-development-environment-configuration/'>
<meta property='og:site_name' content='Le Baron de Charlus'>
<meta property='og:type' content='article'><meta property='article:section' content='Posts' /><meta property='article:tag' content='direnv' /><meta property='article:tag' content='pyenv' /><meta property='article:tag' content='poetry' /><meta property='article:tag' content='pass' /><meta property='article:tag' content='tomb' /><meta property='article:tag' content='gpg' /><meta property='article:tag' content='secrets' /><meta property='article:tag' content='python' /><meta property='article:tag' content='programming' /><meta property='article:published_time' content='2022-06-10T08:12:12&#43;02:00'/><meta property='article:modified_time' content='2022-06-10T08:12:12&#43;02:00'/><meta property='og:image' content='http://localhost:1313/images/ultimate-python.png' />
<meta name="twitter:title" content="Ultimate Python development environment configuration">
<meta name="twitter:description" content="\nThe Old Way Direnv What is direnv and how it works direnv installation Shell configuration How Python works with direnv Pyenv Installation and Configuration Use pyenv with direnv Poetry What is Poetry Poetry installation Shell configuration New project Existing project Poetry usage Link Poetry with direnv GPG Generate a key Get key ID Pass Pass installation Pass usage Tomb Tomb installation Tomb usage Secrets with Direnv and Pass Direnv advanced configurations Check for commands dependencies Third-party binaries Third-party configs Final template Conclusion Disclaimer: I&rsquo;m not saying virtualenv methods are bad.\n"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='http://localhost:1313/images/ultimate-python.png' />
    <link rel="shortcut icon" href="/favicon.png" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu2313318429472854461.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">üè†</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Le Baron de Charlus</a></h1>
            <h2 class="site-description">Lead SRE - Unix Professor</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='/cv'
                        target="_blank"
                        title="CV"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://github.com/lebarondecharlus'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://instagram.com/le_baron_photography'
                        target="_blank"
                        title="Instagram"
                        rel="me"
                    >
                        
                        
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-brand-instagram"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 8a4 4 0 0 1 4 -4h8a4 4 0 0 1 4 4v8a4 4 0 0 1 -4 4h-8a4 4 0 0 1 -4 -4z" /><path d="M9 12a3 3 0 1 0 6 0a3 3 0 0 0 -6 0" /><path d="M16.5 7.5v.01" /></svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://www.linkedin.com/in/barondecharlus/'
                        target="_blank"
                        title="LinkedIn"
                        rel="me"
                    >
                        
                        
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-brand-linkedin"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M8 11v5" /><path d="M8 8v.01" /><path d="M12 16v-5" /><path d="M16 16v-3a2 2 0 1 0 -4 0" /><path d="M3 7a4 4 0 0 1 4 -4h10a4 4 0 0 1 4 4v10a4 4 0 0 1 -4 4h-10a4 4 0 0 1 -4 -4z" /></svg>
                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/posts/' >
                
                
                
                <span>Posts</span>
            </a>
        </li>
        
        
        <li >
            <a href='https://instagram.com/le_baron_photography' >
                
                
                
                <span>Photography</span>
            </a>
        </li>
        
        
        <li >
            <a href='/cv' >
                
                
                
                <span>CV</span>
            </a>
        </li>
        
        
        <li >
            <a href='/index.xml' >
                
                
                
                <span></span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>Dark Mode</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">Table of contents</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#what-is-direnv-and-how-it-works">What is direnv and how it works</a></li>
    <li><a href="#direnv-installation">direnv installation</a>
      <ol>
        <li><a href="#package-installation">Package installation</a></li>
        <li><a href="#manual-installation">Manual installation</a></li>
        <li><a href="#shell-configuration">Shell configuration</a></li>
      </ol>
    </li>
    <li><a href="#how-python-works-with-direnv">How python works with direnv</a></li>
  </ol>

  <ol>
    <li><a href="#installation-and-configuration">Installation and Configuration</a></li>
    <li><a href="#use-pyenv-with-direnv">Use pyenv with direnv</a></li>
  </ol>

  <ol>
    <li><a href="#what-is-poetry">What is Poetry</a></li>
    <li><a href="#poetry-installation">Poetry installation</a>
      <ol>
        <li><a href="#poetry-shell-configuration">Poetry shell Configuration</a></li>
      </ol>
    </li>
    <li><a href="#poetry-usage">Poetry usage</a>
      <ol>
        <li><a href="#new-project">New project</a></li>
        <li><a href="#existing-project">Existing project</a></li>
        <li><a href="#add-dependecies">Add dependecies</a></li>
      </ol>
    </li>
    <li><a href="#link-poetry-with-direnv">Link Poetry with direnv</a></li>
  </ol>

  <ol>
    <li><a href="#generate-a-key">Generate a key</a></li>
    <li><a href="#get-key-id">Get key ID</a></li>
  </ol>

  <ol>
    <li><a href="#pass-installation">Pass installation</a></li>
    <li><a href="#pass-usage">Pass usage</a></li>
  </ol>

  <ol>
    <li><a href="#tomb-installation">Tomb installation</a></li>
    <li><a href="#tomb-usage">Tomb usage</a></li>
  </ol>

  <ol>
    <li><a href="#check-for-commands-dependencies">Check for commands dependencies</a></li>
    <li><a href="#third-party-binaries">Third-party binaries</a></li>
    <li><a href="#third-party-configs">Third-party configs</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/posts/ultimate-python-development-environment-configuration/">
                
                    <img src="/images/ultimate-python.png" loading="lazy" alt="Featured image of post Ultimate Python development environment configuration" />
                
            </a>
        </div>
    

    <div class="article-details">
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/posts/ultimate-python-development-environment-configuration/">Ultimate Python development environment configuration</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Jun 10, 2022</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    21 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <p><img src="/images/ultimate-python.png"
	
	
	
	loading="lazy"
	
		alt="Ultimate Python"
	
	
></p>
<ol>
<li><a class="link" href="#the-old-way" >The Old Way</a></li>
<li><a class="link" href="#direnv" >Direnv</a>
<ul>
<li><a class="link" href="#what-is-direnv-and-how-it-works" >What is direnv and how it works</a></li>
<li><a class="link" href="#direnv-installation" >direnv installation</a></li>
<li><a class="link" href="#shell-configuration" >Shell configuration</a></li>
<li><a class="link" href="#how-python-works-with-direnv" >How Python works with direnv</a></li>
</ul>
</li>
<li><a class="link" href="#pyenv" >Pyenv</a>
<ul>
<li><a class="link" href="#installation-and-configuration" >Installation and Configuration</a></li>
<li><a class="link" href="#use-pyenv-with-direnv" >Use pyenv with direnv</a></li>
</ul>
</li>
<li><a class="link" href="#poetry" >Poetry</a>
<ul>
<li><a class="link" href="#what-is-poetry" >What is Poetry</a></li>
<li><a class="link" href="#poetry-installation" >Poetry installation</a></li>
<li><a class="link" href="#poetry-shell-configuration" >Shell configuration</a></li>
<li><a class="link" href="#new-project" >New project</a></li>
<li><a class="link" href="#existing-project" >Existing project</a></li>
<li><a class="link" href="#poetry-usage" >Poetry usage</a></li>
<li><a class="link" href="#link-poetry-with-direnv" >Link Poetry with direnv</a></li>
</ul>
</li>
<li><a class="link" href="#gpg" >GPG</a>
<ul>
<li><a class="link" href="#generate-a-key" >Generate a key</a></li>
<li><a class="link" href="#get-key-id" >Get key ID</a></li>
</ul>
</li>
<li><a class="link" href="#pass" >Pass</a>
<ul>
<li><a class="link" href="#pass-installation" >Pass installation</a></li>
<li><a class="link" href="#pass-usage" >Pass usage</a></li>
</ul>
</li>
<li><a class="link" href="#tomb" >Tomb</a>
<ul>
<li><a class="link" href="#tomb-installation" >Tomb installation</a></li>
<li><a class="link" href="#tomb-usage" >Tomb usage</a></li>
</ul>
</li>
<li><a class="link" href="#secrets-with-direnv-and-pass" >Secrets with Direnv and Pass</a></li>
<li><a class="link" href="#direnv-advanced-configurations" >Direnv advanced configurations</a>
<ul>
<li><a class="link" href="#check-for-commands-dependencies" >Check for commands dependencies</a></li>
<li><a class="link" href="#third-party-binaries" >Third-party binaries</a></li>
<li><a class="link" href="#third-party-configs" >Third-party configs</a></li>
</ul>
</li>
<li><a class="link" href="#final-template" >Final template</a></li>
<li><a class="link" href="#conclusion" >Conclusion</a></li>
</ol>
<p>Disclaimer: I&rsquo;m not saying <code>virtualenv</code> methods are bad.</p>
<h1 id="the-old-way">The Old way
</h1><p>For years now, I&rsquo;ve been using Python for a lot of different projects. My setup environment was quite simple, use <code>virtualenv</code> and work locally.</p>
<p>But I&rsquo;ve faced few pain points by doing so. I was often forgetting to <code>source venv/bin/activate</code>, meaning I <code>pip install my-package</code> on my global system.</p>
<p>I also had bad secrets management by setting them not encrypted in a Shell script loaded at my program start.</p>
<p>As bad as:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">DB_NAME</span><span class="o">=</span><span class="s2">&#34;db_name&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">DB_USER</span><span class="o">=</span><span class="s2">&#34;user&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">DB_PASS</span><span class="o">=</span><span class="s2">&#34;pass&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">DB_HOST</span><span class="o">=</span>172.17.0.2
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">DB_PORT</span><span class="o">=</span><span class="m">3306</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Even if some great code editors can handle <code>python interpreters</code> in virtual environment, such as Vscode, I felt like my workflow automation was not as complete as it could be.</p>
<h1 id="direnv">Direnv
</h1><p>How to ensure not forgetting to load a virtual environment and install package globally while working on our project ?</p>
<h2 id="what-is-direnv-and-how-it-works">What is direnv and how it works
</h2><p>From official documentation</p>
<blockquote>
<p>direnv is an extension for your shell. It augments existing shells with a new feature that can load and unload environment variables depending on the current directory.
Before each prompt, direnv checks for the existence of a .envrc file (and optionally a .env file) in the current and parent directories. If the file exists (and is authorized), it is loaded into a bash sub-shell and all exported variables are then captured by direnv and then made available to the current shell.</p>
<p>It supports hooks for all the common shells like bash, zsh, tcsh and fish. This allows project-specific environment variables without cluttering the ~/.profile file.</p>
<p>Because direnv is compiled into a single static executable, it is fast enough to be unnoticeable on each prompt. It is also language-agnostic and can be used to build solutions similar to rbenv, pyenv and phpenv.</p>
</blockquote>
<h2 id="direnv-installation">direnv installation
</h2><p><code>direnv</code> is accessible through packages in almost all distributions.</p>
<h3 id="package-installation">Package installation
</h3><p>If you want a global system installation :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Œª ~/ sudo apt-get install direnv
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="manual-installation">Manual installation
</h3><p>If you want custom installation, take a look on this <a class="link" href="https://direnv.net/install.sh"  target="_blank" rel="noopener"
    >script</a> hosted by direnv official documentation.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Œª ~/ curl -sfL https://direnv.net/install.sh <span class="p">|</span> bash
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="shell-configuration">Shell configuration
</h3><p>Once <code>direnv</code> is installed you need to configure your <code>$SHELL</code> in order to hook it with your default shell.
It supports <code>bash</code>, <code>zsh</code>, <code>fish</code>, <code>tcsh</code> and <code>elvish</code>.</p>
<p><em>e.g with zsh</em></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Œª ~/ <span class="nb">echo</span> <span class="s1">&#39;eval &#34;$(direnv hook zsh)&#34;&#39;</span> &gt;&gt; ~/.zshrc
</span></span><span class="line"><span class="cl">Œª ~/ <span class="nb">source</span> ~/.zshrc
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="how-python-works-with-direnv">How python works with direnv
</h2><p>We can load a Python virtual environment thanks to <code>direnv</code>, to do so we need to specify <code>layout</code> command in a <code>.envrc</code> file located at our root project.</p>
<p>Let&rsquo;s create our project directory first.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Œª ~/ mkdir project <span class="o">&amp;&amp;</span> <span class="nb">cd</span> project
</span></span></code></pre></td></tr></table>
</div>
</div><p>Creat our <code>.envrc</code> file.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Œª ~/project/ <span class="nb">echo</span> <span class="s1">&#39;layout python3&#39;</span> &gt; .envrc
</span></span></code></pre></td></tr></table>
</div>
</div><p>You will notice an error message like :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">direnv: error project/.envrc is blocked. Run `direnv allow` to approve its content
</span></span></code></pre></td></tr></table>
</div>
</div><p>This is a security way to block default content in your file. You can allow it thanks to :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Œª ~/project/ direnv allow
</span></span><span class="line"><span class="cl">direnv: loading ~/project/.envrc                                                                                                                                                                                     
</span></span><span class="line"><span class="cl">direnv: <span class="nb">export</span> +VIRTUAL_ENV ~PATH
</span></span></code></pre></td></tr></table>
</div>
</div><p>Output inform us that virtual environment was automatically created for us. You won&rsquo;t see any prompt modification (as <code>virtualenv</code> does while <code>source venv/bin/activate</code>) it&rsquo;s normal.</p>
<p>Quick check of our Python binary with :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Œª ~/project/ which python
</span></span><span class="line"><span class="cl">project/.direnv/python-3.10.4/bin/python
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can then work as you normally do through <code>venv</code> by installing your python dependencies.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># install a single package</span>
</span></span><span class="line"><span class="cl">Œª ~/project/ pip install django
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># or install your project dependencies</span>
</span></span><span class="line"><span class="cl">Œª ~/project/ pip install -r requirements.txt
</span></span></code></pre></td></tr></table>
</div>
</div><p><em>Note: we will no longer use <code>pip</code> but <code>poetry</code>, see Poetry section on this post for more information.</em></p>
<p>Just to be clear, <code>direnv</code> will automatically load your virtual environement when you move in your project directory. As soon as you will move out, environment will also be automatically deactivated.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Œª ~/project/ <span class="nb">cd</span> 
</span></span><span class="line"><span class="cl">direnv: unloading
</span></span></code></pre></td></tr></table>
</div>
</div><p>That&rsquo;s could be enough for common use if you don&rsquo;t need a specific Python version other than one installed on your system, in some cases you will want to work with specific versions, that&rsquo;s why we need <code>pyenv</code>.</p>
<h1 id="pyenv">Pyenv
</h1><p><code>pyenv</code> lets you easily switch between multiple versions of Python. It&rsquo;s simple, unobtrusive, and follows the UNIX tradition of single-purpose tools that do one thing well.
It allows you to change Python version for each project and it supported by <code>direnv</code> since <code>2.21.0</code>.</p>
<h2 id="installation-and-configuration">Installation and Configuration
</h2><p>Get <code>pyenv</code> :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Œª ~/ curl -L https://pyenv.run <span class="p">|</span> bash
</span></span></code></pre></td></tr></table>
</div>
</div><p>Configure your $SHELL.</p>
<p><em>e.g with zsh</em></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Œª ~/ <span class="nb">echo</span> <span class="s1">&#39;export PYENV_ROOT=&#34;$HOME/.pyenv&#34;&#39;</span> &gt;&gt; ~/.zshrc
</span></span><span class="line"><span class="cl">Œª ~/ <span class="nb">echo</span> <span class="s1">&#39;command -v pyenv &gt;/dev/null || export PATH=&#34;$PYENV_ROOT/bin:$PATH&#34;&#39;</span> &gt;&gt; ~/.zshrc
</span></span><span class="line"><span class="cl">Œª ~/ <span class="nb">echo</span> <span class="s1">&#39;eval &#34;$(pyenv init -)&#34;&#39;</span> &gt;&gt; ~/.zshrc 
</span></span></code></pre></td></tr></table>
</div>
</div><p>Check installation:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Œª ~/ pyenv --version
</span></span><span class="line"><span class="cl">pyenv 2.3.1
</span></span></code></pre></td></tr></table>
</div>
</div><p>And install latest Python version at this date <code>3.10.5</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Œª ~/ pyenv install 3.10.5
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="use-pyenv-with-direnv">Use pyenv with direnv
</h2><p>Now <code>pyenv</code> is installed, let&rsquo;s interface it with our project and <code>direnv</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Œª ~/ <span class="nb">cd</span> project/
</span></span><span class="line"><span class="cl">Œª ~/ <span class="nb">echo</span> <span class="s1">&#39;layout pyenv 3.10.5&#39;</span> &gt; .envrc
</span></span><span class="line"><span class="cl">Œª ~/ direnv allow
</span></span></code></pre></td></tr></table>
</div>
</div><p>Check our Python version and interpreter :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Œª ~/project/ python --version <span class="o">&amp;&amp;</span> which python
</span></span><span class="line"><span class="cl">Python 3.10.5
</span></span><span class="line"><span class="cl">~/project/.direnv/python-3.10.5/bin/python
</span></span></code></pre></td></tr></table>
</div>
</div><p>That&rsquo;s it.</p>
<h1 id="poetry">Poetry
</h1><h2 id="what-is-poetry">What is Poetry
</h2><p>Poetry is a tool for dependency management and packaging in Python. It allows you to declare the libraries your project depends on and it will manage (install/update) them for you.</p>
<p>Poetry will in fact replace <code>pip</code> usage and provide several useful advantages such as :</p>
<ul>
<li>one configuration file for all dependencies and their configs</li>
<li><em>can create and manage virtual environments</em> &lt;&ndash; True, but we manage with <code>direnv</code></li>
<li>automatically resolves dependencies of installed plugins</li>
</ul>
<h2 id="poetry-installation">Poetry installation
</h2><p>Poetry documentation provides installation guidelines and has a part for <strong>osx/linux/bashonwindows</strong> distributions :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Œª ~/ curl -sSL https://install.python-poetry.org <span class="p">|</span> python3 -
</span></span><span class="line"><span class="cl">Retrieving Poetry metadata
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Welcome to Poetry!</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">This will download and install the latest version of Poetry,
</span></span><span class="line"><span class="cl">a dependency and package manager <span class="k">for</span> Python.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">It will add the <span class="sb">`</span>poetry<span class="sb">`</span> <span class="nb">command</span> to Poetry<span class="err">&#39;</span>s bin directory, located at:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$HOME</span>/.local/bin
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">You can uninstall at any <span class="nb">time</span> by executing this script with the --uninstall option,
</span></span><span class="line"><span class="cl">and these changes will be reverted.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Installing Poetry <span class="o">(</span>1.1.13<span class="o">)</span>: Done
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Poetry <span class="o">(</span>1.1.13<span class="o">)</span> is installed now. Great!
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">You can <span class="nb">test</span> that everything is <span class="nb">set</span> up by executing:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="sb">`</span>poetry --version<span class="sb">`</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can check your installation and <code>poetry</code> version :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Œª ~/ poetry --version 
</span></span><span class="line"><span class="cl">Poetry version 1.1.13
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="poetry-shell-configuration">Poetry shell Configuration
</h3><p>You can enable tab completion for your shell. <a class="link" href="https://python-poetry.org/docs/master/#enable-tab-completion-for-bash-fish-or-zsh"  target="_blank" rel="noopener"
    >This documentation</a> has guide for each shell.</p>
<p><em>e.g with ZSH and Oh-my-zsh</em></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Œª ~/ mkdir <span class="nv">$ZSH_CUSTOM</span>/plugins/poetry
</span></span><span class="line"><span class="cl">poetry completions zsh &gt; <span class="nv">$ZSH_CUSTOM</span>/plugins/poetry/_poetry
</span></span></code></pre></td></tr></table>
</div>
</div><p>For oh-my-zsh, you must then enable poetry in your ~/.zshrc plugins</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">plugins<span class="o">(</span>
</span></span><span class="line"><span class="cl">	poetry
</span></span><span class="line"><span class="cl">	...
</span></span><span class="line"><span class="cl">	<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="poetry-usage">Poetry usage
</h2><p>From <code>poetry</code> documentation, you can use it for new project and|or existing one.</p>
<h3 id="new-project">New project
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Œª ~/ poetry new poetry-demo
</span></span></code></pre></td></tr></table>
</div>
</div><p>This will create the poetry-demo directory with the following content:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">poetry-demo
</span></span><span class="line"><span class="cl">‚îú‚îÄ‚îÄ pyproject.toml
</span></span><span class="line"><span class="cl">‚îú‚îÄ‚îÄ README.md
</span></span><span class="line"><span class="cl">‚îú‚îÄ‚îÄ poetry_demo
</span></span><span class="line"><span class="cl">‚îÇ   ‚îî‚îÄ‚îÄ __init__.py
</span></span><span class="line"><span class="cl">‚îî‚îÄ‚îÄ tests
</span></span><span class="line"><span class="cl">    ‚îî‚îÄ‚îÄ __init__.py
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="existing-project">Existing project
</h3><p>Instead of creating a new project, Poetry can be used to ‚Äòinitialise‚Äô a pre-populated directory. To interactively create a <code>pyproject.toml</code> file in directory pre-existing-project :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Œª ~/ <span class="nb">cd</span> project
</span></span><span class="line"><span class="cl">Œª ~/project/ poetry init
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="add-dependecies">Add dependecies
</h3><p>As simple as :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Œª ~/project/ poetry add django
</span></span><span class="line"><span class="cl">Using version ^4.0.5 <span class="k">for</span> Django
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Updating dependencies
</span></span><span class="line"><span class="cl">Resolving dependencies... <span class="o">(</span>0.9s<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Writing lock file
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Package operations: <span class="m">3</span> installs, <span class="m">0</span> updates, <span class="m">0</span> removals
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  ‚Ä¢ Installing asgiref <span class="o">(</span>3.5.2<span class="o">)</span>
</span></span><span class="line"><span class="cl">  ‚Ä¢ Installing sqlparse <span class="o">(</span>0.4.2<span class="o">)</span>
</span></span><span class="line"><span class="cl">  ‚Ä¢ Installing django <span class="o">(</span>4.0.5<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>It will automatically find a suitable version constraint and install the package and sub-dependencies.</p>
<p>Find details on your <code>toml</code> config file :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Œª ~/project/ cat pyproject.toml 
</span></span><span class="line"><span class="cl"><span class="o">[</span>tool.poetry<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">name</span> <span class="o">=</span> <span class="s2">&#34;project&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">version</span> <span class="o">=</span> <span class="s2">&#34;0.1.0&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">description</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">authors</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&#34;Corentin Deret &lt;corentin.deret@payfit.com&gt;&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>tool.poetry.dependencies<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">python</span> <span class="o">=</span> <span class="s2">&#34;^3.10&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">Django</span> <span class="o">=</span> <span class="s2">&#34;^4.0.5&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>tool.poetry.dev-dependencies<span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>build-system<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">requires</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&#34;poetry-core&gt;=1.0.0&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">build-backend <span class="o">=</span> <span class="s2">&#34;poetry.core.masonry.api&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="link-poetry-with-direnv">Link Poetry with direnv
</h2><p>From <code>poetry</code> documentation :</p>
<blockquote>
<p>By default, poetry creates a virtual environment in {cache-dir}/virtualenvs ({cache-dir}\virtualenvs on Windows). You can change the cache-dir value by editing the poetry config. Additionally, you can use the virtualenvs.in-project configuration variable to create virtual environment within your project directory.</p>
</blockquote>
<p>What we want here, is to tell <code>poetry</code> not to configure its own environment but to use our previous <code>direnv</code> configuration.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># .envrc</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">layout pyenv 3.10.5
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># POETRY</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[[</span> ! -f pyproject.toml <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">  log_status <span class="s1">&#39;No pyproject.toml found. Will initialize poetry in no-interactive mode&#39;</span>
</span></span><span class="line"><span class="cl">  poetry init -n -q
</span></span><span class="line"><span class="cl">  poetry run pip install -U pip wheel setuptools
</span></span><span class="line"><span class="cl"><span class="k">fi</span>  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">poetry run <span class="nb">echo</span> &gt;&gt; /dev/null
</span></span><span class="line"><span class="cl"><span class="nb">local</span> <span class="nv">VENV</span><span class="o">=</span><span class="k">$(</span>dirname <span class="k">$(</span>poetry run which python<span class="k">))</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">VIRTUAL_ENV</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$VENV</span><span class="s2">&#34;</span> <span class="p">|</span> rev <span class="p">|</span> cut -d<span class="s1">&#39;/&#39;</span> -f2- <span class="p">|</span> rev<span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">POETRY_ACTIVE</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">PATH_add <span class="s2">&#34;</span><span class="nv">$VENV</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> ! -L .venv <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">  ln -ns <span class="nv">$VIRTUAL_ENV</span> .venv
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s allow our <code>direnv</code> and check that we are using our correct environment.</p>
<p>For our example with django, we should be able to retrieve our dependencie in <code>.direnv</code> folder.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Œª ~/project/ find .direnv -name <span class="s1">&#39;django&#39;</span>  
</span></span><span class="line"><span class="cl">.direnv/python-3.10.5/lib/python3.10/site-packages/django
</span></span><span class="line"><span class="cl">.direnv/python-3.10.5/lib/python3.10/site-packages/django/forms/jinja2/django
</span></span><span class="line"><span class="cl">.direnv/python-3.10.5/lib/python3.10/site-packages/django/forms/templates/django
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="gpg">GPG
</h1><p>Remember about managing secrets ? Now that we have our virtual environements set, how can we manage to work with secrets without write them directly in our project/repository ?</p>
<p>Before we can use a password manager such as <code>pass</code> we need a <code>gpg key id</code>.</p>
<h2 id="generate-a-key">Generate a key
</h2><p>Let&rsquo;s first generete one.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Œª ~/ gpg --full-generate-key
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Please <span class="k">select</span> what kind of key you want:
</span></span><span class="line"><span class="cl">   <span class="o">(</span>1<span class="o">)</span> RSA and RSA <span class="o">(</span>default<span class="o">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">(</span>2<span class="o">)</span> DSA and Elgamal
</span></span><span class="line"><span class="cl">   <span class="o">(</span>3<span class="o">)</span> DSA <span class="o">(</span>sign only<span class="o">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">(</span>4<span class="o">)</span> RSA <span class="o">(</span>sign only<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">(</span>14<span class="o">)</span> Existing key from card
</span></span><span class="line"><span class="cl">Your selection? <span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">RSA keys may be between <span class="m">1024</span> and <span class="m">4096</span> bits long.
</span></span><span class="line"><span class="cl">What keysize <span class="k">do</span> you want? <span class="o">(</span>3072<span class="o">)</span> 
</span></span><span class="line"><span class="cl">Requested keysize is <span class="m">3072</span> bits
</span></span><span class="line"><span class="cl">Please specify how long the key should be valid.
</span></span><span class="line"><span class="cl">         <span class="nv">0</span> <span class="o">=</span> key does not expire
</span></span><span class="line"><span class="cl">      &lt;n&gt;  <span class="o">=</span> key expires in n days
</span></span><span class="line"><span class="cl">      &lt;n&gt;w <span class="o">=</span> key expires in n weeks
</span></span><span class="line"><span class="cl">      &lt;n&gt;m <span class="o">=</span> key expires in n months
</span></span><span class="line"><span class="cl">      &lt;n&gt;y <span class="o">=</span> key expires in n years
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Key is valid <span class="k">for</span>? <span class="o">(</span>0<span class="o">)</span> 
</span></span><span class="line"><span class="cl">Key does not expire at all
</span></span><span class="line"><span class="cl">Is this correct? <span class="o">(</span>y/N<span class="o">)</span> y
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Real name: Kader Ovski
</span></span><span class="line"><span class="cl">Email address: me@lebaron.sh
</span></span><span class="line"><span class="cl">Comment: 
</span></span><span class="line"><span class="cl">You selected this USER-ID:
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;Kader Ovski &lt;me@lebaron.sh&gt;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Change <span class="o">(</span>N<span class="o">)</span>ame, <span class="o">(</span>C<span class="o">)</span>omment, <span class="o">(</span>E<span class="o">)</span>mail or <span class="o">(</span>O<span class="o">)</span>kay/<span class="o">(</span>Q<span class="o">)</span>uit? O
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">We need to generate a lot of random bytes. It is a good idea to perform
</span></span><span class="line"><span class="cl">some other action <span class="o">(</span><span class="nb">type</span> on the keyboard, move the mouse, utilize the
</span></span><span class="line"><span class="cl">disks<span class="o">)</span> during the prime generation<span class="p">;</span> this gives the random number
</span></span><span class="line"><span class="cl">generator a better chance to gain enough entropy.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">gpg: key 0854057891EFB8F0 marked as ultimately trusted
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">pub   rsa3072 2022-06-10 <span class="o">[</span>SC<span class="o">]</span>
</span></span><span class="line"><span class="cl">      DC3EC748A8D97169F47C16690854057891EFB8F0
</span></span><span class="line"><span class="cl">uid                      Kader Ovski &lt;me@lebaron.sh&gt;
</span></span><span class="line"><span class="cl">sub   rsa3072 2022-06-10 <span class="o">[</span>E<span class="o">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="get-key-id">Get key ID
</h2><p>We can then list our new key :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Œª ~/ gpg --list-keys
</span></span><span class="line"><span class="cl">gpg: checking the trustdb
</span></span><span class="line"><span class="cl">gpg: marginals needed: <span class="m">3</span>  completes needed: <span class="m">1</span>  trust model: pgp
</span></span><span class="line"><span class="cl">gpg: depth: <span class="m">0</span>  valid:   <span class="m">1</span>  signed:   <span class="m">0</span>  trust: 0-, 0q, 0n, 0m, 0f, 1u
</span></span><span class="line"><span class="cl"><span class="nv">$HOME</span>/.gnupg/pubring.kbx
</span></span><span class="line"><span class="cl">------------------------
</span></span><span class="line"><span class="cl">pub   rsa3072 2022-06-10 <span class="o">[</span>SC<span class="o">]</span>
</span></span><span class="line"><span class="cl">      DC3EC748A8D97169F47C16690854057891EFB8F0
</span></span><span class="line"><span class="cl">uid           <span class="o">[</span>ultimate<span class="o">]</span> Kader Ovski &lt;me@lebaron.sh&gt;
</span></span><span class="line"><span class="cl">sub   rsa3072 2022-06-10 <span class="o">[</span>E<span class="o">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="pass">Pass
</h1><p><code>pass</code> is the standard unix password manager.</p>
<blockquote>
<p>With pass, each password lives inside of a gpg encrypted file whose filename is the title of the website or resource that requires the password. These encrypted files may be organized into meaningful folder hierarchies, copied from computer to computer, and, in general, manipulated using standard command line file management utilities.</p>
</blockquote>
<h2 id="pass-installation">Pass installation
</h2><p><code>pass</code> is available in almost all distribution and can be installed as follow:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Œª ~/ sudo apt-get install pass
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="pass-usage">Pass usage
</h2><p>Now that we have <code>pass</code> installed on our system <strong>and</strong> a valid <code>gpg_key_id</code> we can init our password manager with :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Œª ~/ pass init DC3EC748A8D97169F47C16690854057891EFB8F0
</span></span><span class="line"><span class="cl">mkdir: created directory <span class="s1">&#39;$HOME/.password-store/&#39;</span>
</span></span><span class="line"><span class="cl">Password store initialized <span class="k">for</span> DC3EC748A8D97169F47C16690854057891EFB8F0
</span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s insert our first password :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Œª ~/ pass insert lebaron.sh/blog/some_secret
</span></span><span class="line"><span class="cl">mkdir: created directory <span class="s1">&#39;$HOME/.password-store/lebaron.sh&#39;</span>
</span></span><span class="line"><span class="cl">mkdir: created directory <span class="s1">&#39;$HOME/.password-store/lebaron.sh/blog&#39;</span>
</span></span><span class="line"><span class="cl">Enter password <span class="k">for</span> lebaron.sh/blog/some_secret: 
</span></span><span class="line"><span class="cl">Retype password <span class="k">for</span> lebaron.sh/blog/some_secret: 
</span></span></code></pre></td></tr></table>
</div>
</div><p>Our password is now store in our <code>pass</code> :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Œª ~/ pass
</span></span><span class="line"><span class="cl">Password Store
</span></span><span class="line"><span class="cl"><span class="sb">`</span>-- lebaron.sh
</span></span><span class="line"><span class="cl">    <span class="sb">`</span>-- blog
</span></span><span class="line"><span class="cl">        <span class="sb">`</span>-- some_secret
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can get your secret by typing and entering your gpg secret passphrase :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Œª ~/ pass show lebaron.sh/blog/some_secret
</span></span><span class="line"><span class="cl">my_secret
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="tomb">Tomb
</h1><p>Due to the structure of pass, file and directory names are not encrypted in the password store. <code>pass-tomb</code> provides a convenient solution to put your password store in a Tomb and then keep your password tree encrypted when you are not using it.</p>
<p>It uses the same GPG key to encrypt passwords and tomb, therefore you don&rsquo;t need to manage more key or secret. Moreover, you can ask pass-tomb to automatically close your store after a given time.</p>
<h2 id="tomb-installation">Tomb installation
</h2><p>You can use package installation on your distribution :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Œª ~/ sudo apt install pass-extension-tomb
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="tomb-usage">Tomb usage
</h2><p>Create a new password tomb:</p>
<p><em>e.g</em></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">&gt; pass tomb DC3EC748A8D97169F47C16690854057891EFB8F0
</span></span><span class="line"><span class="cl"> <span class="o">(</span>*<span class="o">)</span> Your password tomb has been created and opened in ~/.password-store.
</span></span><span class="line"><span class="cl"> <span class="o">(</span>*<span class="o">)</span> Password store initialized <span class="k">for</span> DC3EC748A8D97169F47C16690854057891EFB8F0
</span></span><span class="line"><span class="cl">  .  Your tomb is: ~/.password.tomb
</span></span><span class="line"><span class="cl">  .  Your tomb key is: ~/.password.key.tomb
</span></span><span class="line"><span class="cl">  .  You can now use pass as usual.
</span></span><span class="line"><span class="cl">  .  When finished, close the password tomb using <span class="s1">&#39;pass close&#39;</span>.
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can now use the best part of <code>pass-tomb</code>:</p>
<ul>
<li>open your tomb</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Œª ~/ pass open
</span></span><span class="line"><span class="cl"> <span class="o">(</span>*<span class="o">)</span> Your password tomb has been opened in <span class="nv">$HOME</span>/.password-store/.
</span></span><span class="line"><span class="cl">  .  You can now use pass as usual.
</span></span><span class="line"><span class="cl">  .  When finished, close the password tomb using <span class="s1">&#39;pass close&#39;</span>.
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>close your tomb</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Œª ~/ pass close
</span></span><span class="line"><span class="cl"> <span class="o">(</span>*<span class="o">)</span> Your password tomb has been closed.
</span></span><span class="line"><span class="cl">  .  Your passwords remain present in <span class="nv">$HOME</span>/.password.tomb.
</span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s check what is happening with <code>open</code> and <code>close</code> options.</p>
<p>When our <code>tomb</code> is closed, <code>pass</code> command and our passwords path looks like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Œª ~/ pass
</span></span><span class="line"><span class="cl">Password Store
</span></span><span class="line"><span class="cl">‚îî‚îÄ‚îÄ <span class="m">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Œª ~/ tree .password-store/            
</span></span><span class="line"><span class="cl">.password-store/
</span></span><span class="line"><span class="cl">‚îî‚îÄ‚îÄ <span class="m">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">1</span> directory, <span class="m">0</span> files
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can not see our key:value (path/password-name) elements on output and filesystem.</p>
<p>When opening our <code>tomb</code> we are decrypting our password database :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Œª ~/ pass <span class="p">;</span> tree .password-store/
</span></span><span class="line"><span class="cl">Password Store
</span></span><span class="line"><span class="cl">‚îú‚îÄ‚îÄ lebaron.sh
</span></span><span class="line"><span class="cl">‚îÇ¬†¬† ‚îî‚îÄ‚îÄ blog
</span></span><span class="line"><span class="cl">‚îÇ¬†      ‚îî‚îÄ‚îÄ some_secret.gpg
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Œª ~/ tree .password-store/            
</span></span><span class="line"><span class="cl">.password-store/
</span></span><span class="line"><span class="cl">‚îú‚îÄ‚îÄ lebaron.sh
</span></span><span class="line"><span class="cl">‚îÇ¬†¬† ‚îî‚îÄ‚îÄ blog
</span></span><span class="line"><span class="cl">‚îÇ¬†      ‚îî‚îÄ‚îÄ some_secret.gpg
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="secrets-with-direnv-and-pass">Secrets with direnv and pass
</h1><p>We can now manage to use our <code>secrets</code> in our Python code thanks to <code>direnv</code> and <code>pass</code>.</p>
<p>We need to modify a bit our <code>.envrc</code> in our project directory by checking if the <code>tomb</code> is open or not.
I&rsquo;m doing it by checking if I can <code>stat</code> my <code>$HOME/.password-store/.gpg-id</code> which is possible when the <code>tomb</code> is open. If not it means <code>tomb</code> is close and need to be open.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># .envrc</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">layout pyenv 3.10.5
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># POETRY</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[[</span> ! -f pyproject.toml <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">  log_status <span class="s1">&#39;No pyproject.toml found. Will initialize poetry in no-interactive mode&#39;</span>
</span></span><span class="line"><span class="cl">  poetry init -n -q
</span></span><span class="line"><span class="cl">  poetry run pip install -U pip wheel setuptools
</span></span><span class="line"><span class="cl"><span class="k">fi</span>  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">poetry run <span class="nb">echo</span> &gt;&gt; /dev/null
</span></span><span class="line"><span class="cl"><span class="nb">local</span> <span class="nv">VENV</span><span class="o">=</span><span class="k">$(</span>dirname <span class="k">$(</span>poetry run which python<span class="k">))</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">VIRTUAL_ENV</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$VENV</span><span class="s2">&#34;</span> <span class="p">|</span> rev <span class="p">|</span> cut -d<span class="s1">&#39;/&#39;</span> -f2- <span class="p">|</span> rev<span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">POETRY_ACTIVE</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">PATH_add <span class="s2">&#34;</span><span class="nv">$VENV</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> ! -L .venv <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">  ln -ns <span class="nv">$VIRTUAL_ENV</span> .venv
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># CHEKING IF¬†TOMB IS OPEN</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> ! stat <span class="nv">$HOME</span>/.password-store/.gpg-id &gt; /dev/null 2&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># IF¬†NOT OPEN IT</span>
</span></span><span class="line"><span class="cl">    pass open
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># THEN¬†PUT¬†SECRET¬†IN ENV</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">MY_SECRET</span><span class="o">=</span><span class="k">$(</span>pass show lebaron.sh/blog/some_secret<span class="k">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can now reload our <code>direnv</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Œª ~/project/ direnv reload
</span></span><span class="line"><span class="cl">direnv: loading ~/project/.envrc
</span></span><span class="line"><span class="cl"> <span class="o">(</span>*<span class="o">)</span> Your password tomb has been opened in /home/<span class="nv">$USER</span>/.password-store/.
</span></span><span class="line"><span class="cl">  .  You can now use pass as usual.
</span></span><span class="line"><span class="cl">  .  When finished, close the password tomb using <span class="s1">&#39;pass close&#39;</span>.
</span></span><span class="line"><span class="cl">direnv: <span class="nb">export</span> +MY_SECRET +VIRTUAL_ENV ~PATH
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notice here <code>+MY_SECRET</code> in the output, telling us it is accessible through our environment.</p>
<p>We can try to reach our secret :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Œª ~/project/ <span class="nb">echo</span> <span class="nv">$MY_SECRET</span>
</span></span><span class="line"><span class="cl">my_secret
</span></span></code></pre></td></tr></table>
</div>
</div><p>What is really important here is that <strong>we are not storing clear secrets</strong> in our code, project or repo.
All our secrets will be reachable through our virtual environment and can be used in you Python code like this :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">secret</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;MY_SECRET&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">secret</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">my_secret</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="direnv-advanced-configurations">Direnv advanced configurations
</h1><p>In more complex projects you may need <code>commands</code>, <code>external dependencies</code>, <code>third-party</code>, or <code>third-party configuration</code>. Let&rsquo;s see how we can manage them with <code>direnv</code>.</p>
<h2 id="check-for-commands-dependencies">Check for commands dependencies
</h2><p>In your <code>.envrc</code> file, you can ensure you can use and reach some commands needed in your project.</p>
<p>You can do as follow:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># .envrc</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">layout pyenv 3.10.5
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># POETRY</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[[</span> ! -f pyproject.toml <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">  log_status <span class="s1">&#39;No pyproject.toml found. Will initialize poetry in no-interactive mode&#39;</span>
</span></span><span class="line"><span class="cl">  poetry init -n -q
</span></span><span class="line"><span class="cl">  poetry run pip install -U pip wheel setuptools
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">poetry run <span class="nb">echo</span> &gt;&gt; /dev/null
</span></span><span class="line"><span class="cl"><span class="nb">local</span> <span class="nv">VENV</span><span class="o">=</span><span class="k">$(</span>dirname <span class="k">$(</span>poetry run which python<span class="k">))</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">VIRTUAL_ENV</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$VENV</span><span class="s2">&#34;</span> <span class="p">|</span> rev <span class="p">|</span> cut -d<span class="s1">&#39;/&#39;</span> -f2- <span class="p">|</span> rev<span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">POETRY_ACTIVE</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">PATH_add <span class="s2">&#34;</span><span class="nv">$VENV</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> ! -L .venv <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">  ln -ns <span class="nv">$VIRTUAL_ENV</span> .venv
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># CHEKING IF TOMB IS OPEN</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> ! stat <span class="nv">$HOME</span>/.password-store/.gpg-id &gt; /dev/null 2&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># IF NOT OPEN IT</span>
</span></span><span class="line"><span class="cl">    pass open
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># THEN PUT SECRET IN ENV</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">MY_SECRET</span><span class="o">=</span><span class="k">$(</span>pass show lebaron.sh/blog/some_secret<span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># CHECKING COMMANDS DEPENDENCIES</span>
</span></span><span class="line"><span class="cl"><span class="nv">DIRENV_CMD_DEPENDENCIES</span><span class="o">=</span><span class="s2">&#34;unzip tar mkdir curl chmod rm&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> mandatory_cmd in <span class="si">${</span><span class="nv">DIRENV_CMD_DEPENDENCIES</span><span class="si">}</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&#34;</span><span class="k">$(</span>which <span class="si">${</span><span class="nv">mandatory_cmd</span><span class="si">}</span><span class="k">)</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;===&gt; Mandatory command not found: </span><span class="si">${</span><span class="nv">mandatory_cmd</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">   <span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="third-party-binaries">Third-party binaries
</h2><p>We can arrange to use specific third-party binaries such as <code>packer</code>, <code>terraform</code>, <code>vault</code> etc‚Ä¶</p>
<p>We will tell <code>.direnv</code> to use <code>PATH</code> in order to place our third-party binaries in <code>.direnv/bin</code> path.</p>
<p>Let&rsquo;s grab our <code>.envrc</code> file again:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># .envrc</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">layout pyenv 3.10.5
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># POETRY</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[[</span> ! -f pyproject.toml <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">  log_status <span class="s1">&#39;No pyproject.toml found. Will initialize poetry in no-interactive mode&#39;</span>
</span></span><span class="line"><span class="cl">  poetry init -n -q
</span></span><span class="line"><span class="cl">  poetry run pip install -U pip wheel setuptools
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">poetry run <span class="nb">echo</span> &gt;&gt; /dev/null
</span></span><span class="line"><span class="cl"><span class="nb">local</span> <span class="nv">VENV</span><span class="o">=</span><span class="k">$(</span>dirname <span class="k">$(</span>poetry run which python<span class="k">))</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">VIRTUAL_ENV</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$VENV</span><span class="s2">&#34;</span> <span class="p">|</span> rev <span class="p">|</span> cut -d<span class="s1">&#39;/&#39;</span> -f2- <span class="p">|</span> rev<span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">POETRY_ACTIVE</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">PATH_add <span class="s2">&#34;</span><span class="nv">$VENV</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> ! -L .venv <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">  ln -ns <span class="nv">$VIRTUAL_ENV</span> .venv
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># CHEKING IF TOMB IS OPEN</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> ! stat <span class="nv">$HOME</span>/.password-store/.gpg-id &gt; /dev/null 2&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># IF NOT OPEN IT</span>
</span></span><span class="line"><span class="cl">    pass open
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># THEN PUT SECRET IN ENV</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">MY_SECRET</span><span class="o">=</span><span class="k">$(</span>pass show lebaron.sh/blog/some_secret<span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># CHECKING COMMANDS DEPENDENCIES</span>
</span></span><span class="line"><span class="cl"><span class="nv">DIRENV_CMD_DEPENDENCIES</span><span class="o">=</span><span class="s2">&#34;unzip tar mkdir curl chmod rm&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> mandatory_cmd in <span class="si">${</span><span class="nv">DIRENV_CMD_DEPENDENCIES</span><span class="si">}</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&#34;</span><span class="k">$(</span>which <span class="si">${</span><span class="nv">mandatory_cmd</span><span class="si">}</span><span class="k">)</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;===&gt; Mandatory command not found: </span><span class="si">${</span><span class="nv">mandatory_cmd</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">   <span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">DIRENV_TMP_DIR</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span><span class="s2">/.direnv&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">DIRENV_BIN_DIR</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">DIRENV_TMP_DIR</span><span class="si">}</span><span class="s2">/bin&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> ! -e <span class="s2">&#34;</span><span class="si">${</span><span class="nv">DIRENV_BIN_DIR</span><span class="si">}</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">   mkdir -p <span class="s2">&#34;</span><span class="si">${</span><span class="nv">DIRENV_BIN_DIR</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">DIRENV_BIN_DIR</span><span class="si">}</span><span class="s2">:</span><span class="si">${</span><span class="nv">PATH</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now install our binary, let&rsquo;s try it with <code>packer</code> Hashicorp binary :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># .envrc</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">layout pyenv 3.10.5
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># POETRY</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[[</span> ! -f pyproject.toml <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">  log_status <span class="s1">&#39;No pyproject.toml found. Will initialize poetry in no-interactive mode&#39;</span>
</span></span><span class="line"><span class="cl">  poetry init -n -q
</span></span><span class="line"><span class="cl">  poetry run pip install -U pip wheel setuptools
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">poetry run <span class="nb">echo</span> &gt;&gt; /dev/null
</span></span><span class="line"><span class="cl"><span class="nb">local</span> <span class="nv">VENV</span><span class="o">=</span><span class="k">$(</span>dirname <span class="k">$(</span>poetry run which python<span class="k">))</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">VIRTUAL_ENV</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$VENV</span><span class="s2">&#34;</span> <span class="p">|</span> rev <span class="p">|</span> cut -d<span class="s1">&#39;/&#39;</span> -f2- <span class="p">|</span> rev<span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">POETRY_ACTIVE</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">PATH_add <span class="s2">&#34;</span><span class="nv">$VENV</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> ! -L .venv <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">  ln -ns <span class="nv">$VIRTUAL_ENV</span> .venv
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># CHEKING IF TOMB IS OPEN</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> ! stat <span class="nv">$HOME</span>/.password-store/.gpg-id &gt; /dev/null 2&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># IF NOT OPEN IT</span>
</span></span><span class="line"><span class="cl">    pass open
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># THEN PUT SECRET IN ENV</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">MY_SECRET</span><span class="o">=</span><span class="k">$(</span>pass show lebaron.sh/blog/some_secret<span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># CHECKING COMMANDS DEPENDENCIES</span>
</span></span><span class="line"><span class="cl"><span class="nv">DIRENV_CMD_DEPENDENCIES</span><span class="o">=</span><span class="s2">&#34;unzip tar mkdir curl chmod rm&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> mandatory_cmd in <span class="si">${</span><span class="nv">DIRENV_CMD_DEPENDENCIES</span><span class="si">}</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&#34;</span><span class="k">$(</span>which <span class="si">${</span><span class="nv">mandatory_cmd</span><span class="si">}</span><span class="k">)</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;===&gt; Mandatory command not found: </span><span class="si">${</span><span class="nv">mandatory_cmd</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">   <span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">DIRENV_TMP_DIR</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span><span class="s2">/.direnv&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">DIRENV_BIN_DIR</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">DIRENV_TMP_DIR</span><span class="si">}</span><span class="s2">/bin&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> ! -e <span class="s2">&#34;</span><span class="si">${</span><span class="nv">DIRENV_BIN_DIR</span><span class="si">}</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">   mkdir -p <span class="s2">&#34;</span><span class="si">${</span><span class="nv">DIRENV_BIN_DIR</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">DIRENV_BIN_DIR</span><span class="si">}</span><span class="s2">:</span><span class="si">${</span><span class="nv">PATH</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># PACKER INSTALLATION</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">PACKER_VERSION</span><span class="o">=</span><span class="s2">&#34;1.8.1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">PACKER_ARCH</span><span class="o">=</span><span class="s2">&#34;linux_amd64&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">PACKER_PKG_NAME</span><span class="o">=</span><span class="s2">&#34;packer_</span><span class="si">${</span><span class="nv">PACKER_VERSION</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">PACKER_ARCH</span><span class="si">}</span><span class="s2">.zip&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">PACKER_PKG_URL</span><span class="o">=</span><span class="s2">&#34;https://releases.hashicorp.com/packer/</span><span class="si">${</span><span class="nv">PACKER_VERSION</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">PACKER_PKG_NAME</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">PACKER_PKG_PATH</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">DIRENV_TMP_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">PACKER_PKG_NAME</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> ! -e <span class="s2">&#34;</span><span class="si">${</span><span class="nv">DIRENV_BIN_DIR</span><span class="si">}</span><span class="s2">/packer&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">   <span class="nb">echo</span> <span class="s2">&#34;===&gt; Getting packer:</span><span class="si">${</span><span class="nv">PACKER_VERSION</span><span class="si">}</span><span class="s2">:</span><span class="si">${</span><span class="nv">PACKER_ARCH</span><span class="si">}</span><span class="s2"> (can take a while to execute)&#34;</span>
</span></span><span class="line"><span class="cl">   curl -s -L <span class="s2">&#34;</span><span class="si">${</span><span class="nv">PACKER_PKG_URL</span><span class="si">}</span><span class="s2">&#34;</span> -o <span class="s2">&#34;</span><span class="si">${</span><span class="nv">PACKER_PKG_PATH</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">   unzip <span class="si">${</span><span class="nv">PACKER_PKG_PATH</span><span class="si">}</span> -d <span class="si">${</span><span class="nv">DIRENV_BIN_DIR</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">   chmod <span class="m">700</span> <span class="si">${</span><span class="nv">DIRENV_BIN_DIR</span><span class="si">}</span>/packer
</span></span><span class="line"><span class="cl">   rm -f <span class="si">${</span><span class="nv">PACKER_PKG_PATH</span><span class="si">}</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s try out our new configuration :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Œª ~/project direnv allow
</span></span><span class="line"><span class="cl">direnv: loading ~/project/.envrc                                                                    
</span></span><span class="line"><span class="cl"><span class="o">===</span>&gt; Getting packer:1.8.1:linux_amd64 <span class="o">(</span>can take a <span class="k">while</span> to execute<span class="o">)</span>
</span></span><span class="line"><span class="cl">Archive:  ~/project/.direnv/packer_1.8.1_linux_amd64.zip
</span></span><span class="line"><span class="cl">  inflating: ~/project/.direnv/bin/packer  
</span></span><span class="line"><span class="cl">direnv: <span class="nb">export</span> +MY_SECRET +VIRTUAL_ENV ~PATH
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now <code>packer</code> is installed in our <code>PATH</code> let&rsquo;s locate it and run it :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Œª ~/project/ which packer
</span></span><span class="line"><span class="cl">~/project/.direnv/bin/packer
</span></span><span class="line"><span class="cl">Œª ~/ packer --version
</span></span><span class="line"><span class="cl">1.8.1
</span></span></code></pre></td></tr></table>
</div>
</div><p>If in the futur you need to change <code>packer</code> version you just have to remove your current <code>packer</code> binary and modify <code>PACKER_VERSION</code> variable to rebuild your <code>direnv</code>.</p>
<h2 id="third-party-configs">Third-party configs
</h2><p>Of course, if our third-party need custom (or not) configurations we can specify them in our <code>.envrc</code> but to keep pour code clear and organized we also can split our configs into subfiles.</p>
<p>By adding this block at the end of our <code>.envrc</code> file :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># .envrc </span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># [‚Ä¶]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ADDONS</span>
</span></span><span class="line"><span class="cl"><span class="nv">ENV_ADDONS</span><span class="o">=</span><span class="s2">&#34;.env.packer .env.custom_config&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> addon in <span class="si">${</span><span class="nv">ENV_ADDONS</span><span class="si">}</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="o">[</span> -e <span class="s2">&#34;</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">addon</span><span class="si">}</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">       <span class="nb">source</span> <span class="si">${</span><span class="nv">PWD</span><span class="si">}</span>/<span class="si">${</span><span class="nv">addon</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">   <span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>And then create your addons custom config file :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># .env.packer</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">PACKER_VAR1</span><span class="o">=</span>VAR1_VALUE
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">PACKER_VAR2</span><span class="o">=</span>VAR2_VALUE
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># .env.custom_config</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">CUSTOM_VAR1</span><span class="o">=</span>CUSTOM1_VALUE
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">CUSTOM_VAR2</span><span class="o">=</span>CUSTOM2_VALUE
</span></span></code></pre></td></tr></table>
</div>
</div><p>Don&rsquo;t forget to reload:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Œª ~/project/ direnv reload
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="final-template">Final template
</h1><p>Here is a final <code>.envrc</code> template you can grab and edit for your needs :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># .envrc</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">layout pyenv 3.10.5
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># POETRY</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[[</span> ! -f pyproject.toml <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">  log_status <span class="s1">&#39;No pyproject.toml found. Will initialize poetry in no-interactive mode&#39;</span>
</span></span><span class="line"><span class="cl">  poetry init -n -q
</span></span><span class="line"><span class="cl">  poetry run pip install -U pip wheel setuptools
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">poetry run <span class="nb">echo</span> &gt;&gt; /dev/null
</span></span><span class="line"><span class="cl"><span class="nb">local</span> <span class="nv">VENV</span><span class="o">=</span><span class="k">$(</span>dirname <span class="k">$(</span>poetry run which python<span class="k">))</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">VIRTUAL_ENV</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$VENV</span><span class="s2">&#34;</span> <span class="p">|</span> rev <span class="p">|</span> cut -d<span class="s1">&#39;/&#39;</span> -f2- <span class="p">|</span> rev<span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">POETRY_ACTIVE</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">PATH_add <span class="s2">&#34;</span><span class="nv">$VENV</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> ! -L .venv <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">  ln -ns <span class="nv">$VIRTUAL_ENV</span> .venv
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># CHEKING IF TOMB IS OPEN</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> ! stat <span class="nv">$HOME</span>/.password-store/.gpg-id &gt; /dev/null 2&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># IF NOT OPEN IT</span>
</span></span><span class="line"><span class="cl">    pass open
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># THEN PUT SECRET IN ENV</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">MY_SECRET</span><span class="o">=</span><span class="k">$(</span>pass show lebaron.sh/blog/some_secret<span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># CHECKING COMMANDS DEPENDENCIES</span>
</span></span><span class="line"><span class="cl"><span class="nv">DIRENV_CMD_DEPENDENCIES</span><span class="o">=</span><span class="s2">&#34;unzip tar mkdir curl chmod rm&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> mandatory_cmd in <span class="si">${</span><span class="nv">DIRENV_CMD_DEPENDENCIES</span><span class="si">}</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&#34;</span><span class="k">$(</span>which <span class="si">${</span><span class="nv">mandatory_cmd</span><span class="si">}</span><span class="k">)</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;===&gt; Mandatory command not found: </span><span class="si">${</span><span class="nv">mandatory_cmd</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">   <span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">DIRENV_TMP_DIR</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span><span class="s2">/.direnv&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">DIRENV_BIN_DIR</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">DIRENV_TMP_DIR</span><span class="si">}</span><span class="s2">/bin&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> ! -e <span class="s2">&#34;</span><span class="si">${</span><span class="nv">DIRENV_BIN_DIR</span><span class="si">}</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">   mkdir -p <span class="s2">&#34;</span><span class="si">${</span><span class="nv">DIRENV_BIN_DIR</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">DIRENV_BIN_DIR</span><span class="si">}</span><span class="s2">:</span><span class="si">${</span><span class="nv">PATH</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># PACKER INSTALLATION</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">PACKER_VERSION</span><span class="o">=</span><span class="s2">&#34;1.8.1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">PACKER_ARCH</span><span class="o">=</span><span class="s2">&#34;linux_amd64&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">PACKER_PKG_NAME</span><span class="o">=</span><span class="s2">&#34;packer_</span><span class="si">${</span><span class="nv">PACKER_VERSION</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">PACKER_ARCH</span><span class="si">}</span><span class="s2">.zip&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">PACKER_PKG_URL</span><span class="o">=</span><span class="s2">&#34;https://releases.hashicorp.com/packer/</span><span class="si">${</span><span class="nv">PACKER_VERSION</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">PACKER_PKG_NAME</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">PACKER_PKG_PATH</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">DIRENV_TMP_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">PACKER_PKG_NAME</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> ! -e <span class="s2">&#34;</span><span class="si">${</span><span class="nv">DIRENV_BIN_DIR</span><span class="si">}</span><span class="s2">/packer&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">   <span class="nb">echo</span> <span class="s2">&#34;===&gt; Getting packer:</span><span class="si">${</span><span class="nv">PACKER_VERSION</span><span class="si">}</span><span class="s2">:</span><span class="si">${</span><span class="nv">PACKER_ARCH</span><span class="si">}</span><span class="s2"> (can take a while to execute)&#34;</span>
</span></span><span class="line"><span class="cl">   curl -s -L <span class="s2">&#34;</span><span class="si">${</span><span class="nv">PACKER_PKG_URL</span><span class="si">}</span><span class="s2">&#34;</span> -o <span class="s2">&#34;</span><span class="si">${</span><span class="nv">PACKER_PKG_PATH</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">   unzip <span class="si">${</span><span class="nv">PACKER_PKG_PATH</span><span class="si">}</span> -d <span class="si">${</span><span class="nv">DIRENV_BIN_DIR</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">   chmod <span class="m">700</span> <span class="si">${</span><span class="nv">DIRENV_BIN_DIR</span><span class="si">}</span>/packer
</span></span><span class="line"><span class="cl">   rm -f <span class="si">${</span><span class="nv">PACKER_PKG_PATH</span><span class="si">}</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ADDONS</span>
</span></span><span class="line"><span class="cl"><span class="nv">ENV_ADDONS</span><span class="o">=</span><span class="s2">&#34;.env.packer .env.custom_config&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> addon in <span class="si">${</span><span class="nv">ENV_ADDONS</span><span class="si">}</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="o">[</span> -e <span class="s2">&#34;</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">addon</span><span class="si">}</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">       <span class="nb">source</span> <span class="si">${</span><span class="nv">PWD</span><span class="si">}</span>/<span class="si">${</span><span class="nv">addon</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">   <span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="conclusion">Conclusion
</h1><p>Yes this require a bit of knowledge and a some configurations to be efficient in this workflow, but keep in mind that all will be configured automatically and will be more easier version controlled.</p>
<p>You can arrange in order to put your application in production area to share your GPG key or to manage multiple GPG key in a same <code>pass</code> (<em>eg one GPG¬†ID for each team member</em>), version your pass and make it a git version accessible.</p>
<p>All dependencies, with the same packages will be deployed exactly as your developpment area.</p>
<p>Keep it simple.</p>
<p>Starter template is available <a class="link" href="https://gist.github.com/lebarondecharlus/f91f4c29a5f655920d4c65a62eb275b0"  target="_blank" rel="noopener"
    >here</a>.</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/direnv/">Direnv</a>
        
            <a href="/tags/pyenv/">Pyenv</a>
        
            <a href="/tags/poetry/">Poetry</a>
        
            <a href="/tags/pass/">Pass</a>
        
            <a href="/tags/tomb/">Tomb</a>
        
            <a href="/tags/gpg/">Gpg</a>
        
            <a href="/tags/secrets/">Secrets</a>
        
            <a href="/tags/python/">Python</a>
        
            <a href="/tags/programming/">Programming</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2017 - 
        
        2024 Le Baron de Charlus
    </section>
    
    <section class="powerby">
         <br />
        
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.85c5a97e7f8e9b98f6ecdcd1ed140958c47c1fed2f019dc256932afb4488b31f.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
